---
pagination:
  data: collections.chapters
  size: 1
  alias: chapter
permalink: "/chapters/{{ chapter.slug }}/"
---
<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{{ chapter.title }}</title>
    <link rel="stylesheet" href="/styles/main.css">
  </head>
  <body>
    <header>
      <h1>{{ chapter.title }}</h1>
    </header>
    <main>
      <article>
        {{ chapter.html | safe }}
      </article>
    </main>
    {% if "chapter" in page.fileSlug %}
    <!-- Sidebar for chapters -->
    {# <aside style="flex-basis: 250px; margin-left: 20px;"> #}
      <aside class="sidebar">
          <h3>All Chapters</h3>
          <input type="text" id="search-bar" placeholder="Search chapters..." oninput="performSearch(event)">
          <ul id="chapter-list"> {% for chapter in collections.chapters %}
              <li>
                  <a href="{{ chapter.localUrl }}">{{ chapter.title }}</a>
              </li>
              {% endfor %}
          </ul>
      </aside>
    {% endif %}
    <footer>
      <a href="/">Back to Home</a>
    </footer>

    <script>
      const searchBar = document.getElementById("search-bar");
      const chapterList = document.getElementById("chapter-list");
  
      // Save the default list to restore it later
      const defaultChaptersHTML = chapterList.innerHTML;
  
      async function performSearch(event) {
          const query = event.target.value.toLowerCase().trim();
  
          // If the search bar is empty, restore the default list
          if (!query) {
              chapterList.innerHTML = defaultChaptersHTML;
              return;
          }
  
          // Call the serverless function instead of the Ghost API directly
          const apiUrl = `/.netlify/functions/searchPosts?query=${encodeURIComponent(query)}`;
  
          try {
              const response = await fetch(apiUrl);
              if (!response.ok) {
                  throw new Error("Failed to fetch search results.");
              }
  
              const posts = await response.json();
  
              // Update chapter list
              if (posts.length > 0) {
                  chapterList.innerHTML = posts
                      .map(
                          post =>
                              `<li><a href="${post.localUrl}">${post.title}</a></li>`
                      )
                      .join("");
              } else {
                  chapterList.innerHTML = "<li>No results found</li>";
              }
          } catch (error) {
              console.error("Error fetching data from serverless function:", error);
          }
      }
  
      searchBar.addEventListener("input", performSearch);
  </script>
  

  </body>
</html>
